{% extends 'base.html' %}

{% block title %}{{ topic.title }}{% endblock %}


{% block content %}

    <div class="topic">
        <div class="main-topic-info">
            <div class="topic_main" id="topic_main">
                {% if topic.image %}
                    <img class="avatar" src="{{ topic.image.url }}" alt="topic_image">
                {% endif %}
                <h3 class="nickname">{{ topic.title }}</h3>
                <div class="button">
                    {% if is_author %}
                        <form action="{% url 'boomnet:delete_topic' topic.slug %}" method="post">
                            {% csrf_token %}
                            <button class="topic-button" type="submit">Delete {{ topic.title }}</button>
                        </form>
                    {% else %}
                        {% if subscription_exists %}
                          <form action="{% url 'boomnet:unsubscribe' topic.slug %}" method="post">
                            {% csrf_token %}
                            <button class="topic-button" type="submit">Leave</button>
                          </form>
                        {% else %}
                          <form action="{% url 'boomnet:subscribe' topic.slug %}" method="post">
                            {% csrf_token %}
                            <button class="topic-button" type="submit">Join</button>
                          </form>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        <br>
        <hr class="white-text">

        <div class="wrapper">
            <div class="about bg-dark">
                <div class="about-content">
                    <h4 class="white-text">About {{ topic.title }}:</h4>
                    {% if topic.description %}
                        <div class="topic-info">
                            <p class="info">{{ topic.description }}</p>
                        </div>
                    {% endif %}
                    <p class="info-adds">Author: <a href="{% url 'boomnet:view_profile' topic.author.profile.slug %}">{{ topic.author.username }}</a></p>
                    <p class="info-adds">Created {{ topic.created_at }}</p>
                    <p>Members: {{ subscribers }}</p>
                    <form method="post" action="{% url 'boomnet:add_post_to_topic' topic.slug %}">
                        {% csrf_token %}
                        <button type="submit">Create new post</button>
                    </form>
                </div>
            </div>

    {#        <br>#}

            <div class="fropy">

                {% for post in posts %}

                    <div class="post bg-dark">
                        <div class="shapka">
                            {% if post.topic %}

                                <span class="author-link">
                                    <a href="{% url 'boomnet:view_topic' post.topic.slug %}" class="no-underline">
                                        <span class="comment-author">
                                            {% if post.topic.image %}
                                                <img class="avatar" src="{{ post.topic.image.url }}" alt="topic_img">
                                            {% endif %}
                                            {{ post.topic.title }}
                                            <span>
                                                | Posted by:
                                                <a href="{% url 'boomnet:view_profile' post.user.profile.slug %}">
                                                    {{ post.user.username }}
                                                </a>
                                            </span>
                                        </span>
                                    </a>
                                </span>

                            {% else %}

                                <div class="author-link">
                                    <a href="{% url 'boomnet:view_profile' post.user.profile.slug %}">
                                        <div class="comment-author">
                                            <img src="{{ post.user.profile.avatar.url }}" class="avatar" alt="av">
                                            {{ post.user.username }}
                                        </div>
                                    </a>
                                </div>

                            {% endif %}
                        </div>

                        <div class="white-text">
                            <form method="post" action="{% url 'boomnet:vote' post.slug %}">
                                {% csrf_token %}
                                <input type="hidden" name="post_slug" value="{{ post.slug }}">
                                <button type="submit" name="vote_type" value="upvote" class="up-vote">Upvote</button>
                                {{ post.total_votes }}
                                <button type="submit" name="vote_type" value="downvote" class="down-vote">Downvote</button>
                            </form>

                        </div>

                        <a href="{% url 'boomnet:post_detail' post.slug %}" class="no-underline">
                            <div class="post-content">
                                <div class="post-title">
                                    <h4>{{ post.title|linebreaks }}</h4>
                                </div>
                                <div class="post-text">
                                    {{ post.text|linebreaks }}
                                </div>
                                <div class="post-image">
                                    {% if post.image %}
                                        <img src="{{ post.image.url }}" alt="postimg">
                                    {% endif %}
                                </div>
                            </div>
                        </a>

                        <div class="adds-block">
                            <p class="adds">Created {{ post.created_at }}</p>
                            <a class="adds" href="{% url 'boomnet:post_detail' post.slug %}">View all comments</a>
                            {% if request.user.is_authenticated %}
                                {% if post in bookmarked_posts %}
                                    <a class="adds" href="{% url 'boomnet:remove_post_from_bookmarks' post.slug %}">Remove from bookmarks</a>
                                {% else %}
                                    <a class="adds" href="{% url 'boomnet:add_post_to_bookmarks' post.slug %}">Add to bookmarks</a>
                                {% endif %}
                            {% endif %}
                        </div>

                    </div>

                {% empty %}
                    <p>No posts yet</p>
                {% endfor %}

            </div>
        </div>
    </div>

{% endblock %}
